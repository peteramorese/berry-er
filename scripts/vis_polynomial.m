clear;
close all; clc;

% p_1 = [1.00000000000000000000, 182.54417942823437215338, -5728.78120341879639454419, 91664.21616994324722327292, -939703.38140954275149852037, 6547522.45779801439493894577, -30649272.29438303038477897644, 82427539.77020025253295898438, 20074267.48082194477319717407, -1417167159.60536646842956542969, 7866513694.16072273254394531250, -26892385195.03374481201171875000, 65816254012.64037322998046875000, -119151779627.43823242187500000000, 156919797571.75720214843750000000, -138672849809.74914550781250000000, 62265230645.65917968750000000000, -2311736744.35400390625000000000, 69562768671.88476562500000000000, -299693205253.04589843750000000000, 587768924788.99365234375000000000, -761207858483.36572265625000000000, 725860600990.87133789062500000000, -531311577088.20324707031250000000, 302802303486.74389648437500000000, -134118759225.65057373046875000000, 45466404275.67177581787109375000, -11431552753.47084236145019531250, 2012883688.04448890686035156250, -221893052.59248042106628417969, 11536094.07063292898237705231]
% p_2 = [3.63296, 4.35819, -501.328, 5391.42, -32356.3, 128411, -359298, 734201, -1.11886e+06, 1.28533e+06, -1.11522e+06, 725537, -347482, 118379, -26973.7, 3647.67, -181.96]
% p_3 = [5.55276, -67.956, 621.809, -4679.48, 27098.5, -118015, 385171, -944992, 1.75198e+06, -2.46398e+06, 2.62821e+06, -2.11202e+06, 1.25838e+06, -539325, 157297, -27968.4, 2324.79]
% p_4 = [5.48782, -70.5304, 680.556, -5195.28, 29607.8, -124722, 390297, -914593, 1.61712e+06, -2.16779e+06, 2.20312e+06, -1.68598e+06, 955903, -389435, 107817, -18166.7, 1441.76]



% visPolynomial(p_1, 'red')
% hold on
% visPolynomial(p_2, 'green')
% visPolynomial(p_3, 'blue')
% visPolynomial(p_4, 'cyan')

ws_bounds = [-1.2, .7, -.7, .7];
% ws_bounds = [0, 1, 0, 1];

% p_test2d = [0.23846956516861841924, 0.84551775049842858856, 1.31618823368088833092, 0.49356502577170857649, -0.19012532624805089654, -1.01713783099741306160, -0.22660415012720847017, -0.19154690527541262668, 0.00248223658444990392, 0.36799938275353061279, 0.72010059112535174108, -0.70393997293179211283, -2.94078274138297501850, -2.78778663142941240949, -0.89714039904902165290, 0.07164672206204159011, 0.06266711646105704858, -0.00310742069154645861, 1.74326626509634330375, -0.73465290711793329592, -4.13662648218473805173, -4.36971095464036807243, 1.09652885944660738460, 6.61459955245140918123, 4.94297485873141795309, 1.79858002345707745917, 0.23480348276888207693, -1.01002802278897618748, -3.09855802723245687957, 0.15279430343935018755, 10.75222441852292831754, 14.12324137767245701980, 3.64747722349147807108, -5.30346409298476828553, -4.29423942710104711296, -0.95609507349809064181, 4.87608471994336412081, -7.88865055114524693636, -5.15720661670479785244, 4.77495999356369793531, 4.04350219986918091308, 4.62802461246974417008, 2.91432645422582936590, 2.99014433833286830122, 0.74681161613902702356, -2.39601669611316481223, -0.52402399749712458288, 13.58962106767285149544, 12.52551705415453398018, -19.95561164773152995622, -41.50362951199258532142, -28.40452905643223857624, -8.62942489672946067003, -0.96596528169908424388, 3.68027945946398915567, -4.48675981846594140734, -0.77022675947728203028, -3.09936333086807280779, -11.99173642838377418229, 1.48143702025959100865, 14.28409450161962013226, 11.58140848067148453993, 2.65720360970293434377, -2.22950062815521832249, -4.66318621652550291401, 1.53230360330377379796, 13.38568873939925651939, 20.37535377924774593339, 21.16656053031385908980, 15.94675395162761333268, 7.01513319589246009400, 1.27901650151228807317, 0.72235368615143791260, 1.83145327422640491477, 2.15736103769415876741, -4.89819277963553645350, -15.00962606649638786394, -15.15819450329436790526, -7.31820655219978277728, -1.44789145288165332914, -0.05103125854385393012];

p_test2d = [0.25120580719350188437, 0.21762096171840505932, 0.94559471840119968533, 2.23871137997538838249, 2.03875258294782923940, -0.07502066979313326556, 0.22273306815351645582, 0.15682926442741873529, 0.10016503305019774928, 0.30649991882624094686, -0.00281973802175272681, 0.09629214422048448796, -0.23255085554484367094, -3.18886088423931823854, -3.99797833128673119063, -1.28957312790896594379, 0.24279427160865907354, 0.16935813227976836970, 0.79824752731481396495, 1.48782108555604963840, 1.07280396204583894360, -7.17994309558002896665, -8.10010417405328553286, -0.96562873094126189244, -0.31516986988390272018, -0.59449161644113246439, 0.11848641542489701806, -1.15985280856997619026, 1.18290238070099462675, -0.88353900060235446290, -4.33740182146357255988, 6.76472704246134526329, 9.26326975563051746576, 0.59157632932056003483, 0.82017270124413244048, 1.86538387620494461316, 8.62324472995710777923, -9.22829772108144652520, -16.75627784278867693502, 7.49005733079229685245, 18.13163419639022322372, 1.57875701244211086305, -7.56865707950964861084, 4.59390571758581245376, 4.51685274365848954403, 0.97874748016351986735, -9.96442202409320998413, -2.44473810866679741594, 24.34812540439543226967, 9.27800463168387068436, -10.41307002150915650418, 0.07446879305211950850, 10.20418552763717912057, 4.84922538287963611481, 3.61108591791249011749, -3.34390181850005774322, 4.28782621139362163376, -1.65330762338089698460, -17.90228443057048934861, -5.74900971508895963780, 0.59972513653167425218, 1.47737868824947327084, 0.79430086401133337404, -1.80438759157754446960, 2.44405768525075473008, 1.45932875490484548209, -4.24957162180180603173, 5.34665260333736114262, 5.93494879315301204770, -6.18757244423488828033, -3.91669210411408386108, 0.41122757871040960254, 0.69578174272286652524, 0.16793263109941847233, -4.80398646945849350232, -0.54085991690868695514, 10.40338469895311845903, 2.57408461294653534424, -7.23698243597596047039, -2.49841146650735446144, 0.59120068971652628420];
% p_test2d = [5.41903114957861919976, -8.20252220285006927725, -11.43837343965641650811, 10.28966889629548120411, 27.88335374261731658407, 0.62468650249533119734, -19.70699503273789332525, -4.69097798223894812963, 2.22591919539746285750, -2.49367498807824006235, -10.91382956347055710467, 17.97134182187323858670, 65.01828594427530561006, -38.12027316252419950615, -116.80947846119627797634, 20.94840440273981130304, 66.88715183525110319351, 16.19237567500166363743, 3.62786570932786389676, -20.92295436695826538198, 4.96469584125679830322, 93.33275555707234616420, -62.78141221360147028463, -106.60293005362609619624, 63.62817696133879508125, 33.16835780834708202747, -0.12865638062106654615, 33.40108190677653965395, -38.42268826360282218957, -47.26290894321482483065, -66.45889921970228897408, 47.95648599848937010393, 268.34018051739712973358, 29.54639849363866233034, -215.15342193442188545305, -77.58893358914281179750, -14.91007834748751292864, -16.90073843981144818827, 198.01670532470234320499, -110.85829949196340749040, -299.42146795848032070353, 155.09323065616808889899, 222.51956505905400263146, -44.12413641666307739797, -82.37284057923466207285, -51.85983266340707587005, -3.33446521458836286911, 322.41650985830619902117, 52.03135850460296296660, -620.52252720455453527393, -129.57082480133976787329, 402.97615984563435631571, 161.69342494833426826517, -51.05079734950550118810, 50.72389118723526735266, -71.67737918042178080213, -167.98693735408551219734, 244.55131410077672171610, 58.74525407806777366204, -43.34778187352276290767, -2.71191510475273389602, -70.02557672572106639564, -43.28832947154842258897, 50.67933867485808718811, -81.44943288224476418691, -160.69791929674192942912, 219.88095980663422324142, 199.39925223426780576119, -144.03842464685885715880, -165.89510576550060250156, 18.83498464264596350404, 33.39640252753211768777, -8.96791886355735812231, -18.36974689450343589670, 90.76872791326758260766, 11.06729187128053126798, -107.69602023873369489593, -68.13935917416881693498, 27.20644514960133619752, 73.77653330063719749887, 21.71321809430708071886];

visPolynomial2(p_test2d, ws_bounds)
% vizUnsafeSet([-.57, -.53, -.17, -.13])
vizUnsafeSet([-1.2, -1, -0.7, 0.7])
vizUnsafeSet([0.5, 0.7, -0.7, 0.7])
vizUnsafeSet([-1, 0.5, 0.5, 0.7])
vizUnsafeSet([-1, 0.5, -0.7, -0.5])
vizInitSet([-0.8, -0.6, -0.2, 0], 0.443541)

function visPolynomial(coeffs, color)
    x = linspace(0, 1, 100);
    
    % Evaluate the polynomial
    y = polyval(flip(coeffs), x);
    
    % Plot the polynomial
    plot(x, y, 'b', 'LineWidth', 2, 'Color', color);
    xlabel('x');
    ylabel('y');
    title('Visualization of Polynomial');
    grid on;
end

function visPolynomial2(coeffs, ws_bounds)
    [x, y] = meshgrid(linspace(ws_bounds(1), ws_bounds(2), 100), linspace(ws_bounds(3), ws_bounds(4), 100));

    deg = sqrt(length(coeffs));
    coeffs = reshape(coeffs, deg, deg);
    disp(coeffs)
    
    % Evaluate the 2D polynomial
    z = polyval2(coeffs, x, y, 10);
    
    % Plot the 2D polynomial
    surf(x, y, z);
    xlabel('x');
    ylabel('y');
    zlabel('z');
    title('Visualization of 2D Polynomial');
    colormap(jet); 
    % colorbar; % Add a colorbar to show the scale
end

function vizUnsafeSet(bounds)
    vertices = zeros(8, 3);
    vertices(1, :) = [bounds(1), bounds(3), 0];
    vertices(2, :) = [bounds(2), bounds(3), 0];
    vertices(3, :) = [bounds(2), bounds(4), 0];
    vertices(4, :) = [bounds(1), bounds(4), 0];
    vertices(5, :) = [bounds(1), bounds(3), 1];
    vertices(6, :) = [bounds(2), bounds(3), 1];
    vertices(7, :) = [bounds(2), bounds(4), 1];
    vertices(8, :) = [bounds(1), bounds(4), 1];

    faces = zeros(6, 4);
    faces(1, :) = [1, 2, 3, 4];
    faces(2, :) = [5, 6, 7, 8];
    faces(3, :) = [1, 2, 6, 5];
    faces(4, :) = [2, 3, 7, 6];
    faces(5, :) = [3, 4, 8, 7];
    faces(6, :) = [4, 1, 5, 8];

    patch('Vertices', vertices, 'Faces', faces, 'FaceColor', 'red')
end

function vizInitSet(bounds, eta)
    vertices = zeros(8, 3);
    vertices(1, :) = [bounds(1), bounds(3), eta];
    vertices(2, :) = [bounds(2), bounds(3), eta];
    vertices(3, :) = [bounds(2), bounds(4), eta];
    vertices(4, :) = [bounds(1), bounds(4), eta];
    vertices(5, :) = [bounds(1), bounds(3), 1];
    vertices(6, :) = [bounds(2), bounds(3), 1];
    vertices(7, :) = [bounds(2), bounds(4), 1];
    vertices(8, :) = [bounds(1), bounds(4), 1];

    faces = zeros(6, 4);
    faces(1, :) = [1, 2, 3, 4];
    faces(2, :) = [5, 6, 7, 8];
    faces(3, :) = [1, 2, 6, 5];
    faces(4, :) = [2, 3, 7, 6];
    faces(5, :) = [3, 4, 8, 7];
    faces(6, :) = [4, 1, 5, 8];

    patch('Vertices', vertices, 'Faces', faces, 'FaceColor', 'cyan')
end

function z = polyval2(coeffs, x, y, cap)
    z = zeros(size(x));
    for grid_i = 1:size(z, 1)
        for grid_j = 1:size(z, 2)
            for j = 1:size(coeffs, 2)
                z(grid_i, grid_j) = z(grid_i, grid_j) + y(grid_i, grid_j)^(j - 1) * polyval(flip(coeffs(:, j)), x(grid_i, grid_j));
                % z(grid_i, grid_j) = min(z(grid_i, grid_j), cap);
            end
        end
    end
    z = min(z, cap);
end